const fs = require('fs');
const path = require('path');

function generateOptimizedMyIni() {
  const myIniContent = `# MySQL 5.7 Optimized Configuration for POS Restaurant System
# Auto-generated by POS Restaurant Application
# This configuration is optimized for VPN/API server performance with multiple devices
# Tested on MySQL 5.7.x

[mysqld]
# ==================== CONNECTION SETTINGS ====================
bind-address=0.0.0.0
max_connections=500
thread_cache_size=100
max_allowed_packet=64M

# ==================== INNODB SETTINGS (CRITICAL FOR PERFORMANCE) ====================
# InnoDB Buffer Pool - Set to 70% of available RAM (2GB default, adjust based on your system)
innodb_buffer_pool_size=2G
innodb_log_file_size=512M
innodb_flush_log_at_trx_commit=2
innodb_file_per_table=1
innodb_buffer_pool_instances=4
innodb_read_io_threads=8
innodb_write_io_threads=8
innodb_io_capacity=2000
innodb_io_capacity_max=4000

# ==================== QUERY CACHE (MySQL 5.7 - Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ù„Ù„Ø³Ø±Ø¹Ø©) ====================
query_cache_type=1
query_cache_size=256M
query_cache_limit=2M
query_cache_min_res_unit=4K

# ==================== BUFFER SIZES (MySQL 5.7 optimizations) ====================
sort_buffer_size=4M
read_buffer_size=2M
read_rnd_buffer_size=4M
join_buffer_size=2M
tmp_table_size=64M
max_heap_table_size=64M

# ==================== NETWORK & TIMEOUT SETTINGS ====================
net_read_timeout=60
net_write_timeout=60
wait_timeout=28800
interactive_timeout=28800
connect_timeout=10

# ==================== TABLE CACHE ====================
table_open_cache=4096
table_definition_cache=2048
open_files_limit=8192

# ==================== BINARY LOG (ØªØ¹Ø·ÙŠÙ„Ù‡ Ù„Ø³Ø±Ø¹Ø© Ø£ÙƒØ¨Ø±) ====================
skip-log-bin

# ==================== CHARACTER SET ====================
character-set-server=utf8mb4
collation-server=utf8mb4_general_ci

# ==================== PERFORMANCE SCHEMA (ØªØ¹Ø·ÙŠÙ„Ù‡ ÙÙŠ MySQL 5.7 Ù„ØªÙˆÙÙŠØ± Ø§Ù„Ø°Ø§ÙƒØ±Ø©) ====================
performance_schema=OFF

# ==================== SLOW QUERY LOG (Optional - for debugging) ====================
# slow_query_log=1
# slow_query_log_file=slow-queries.log
# long_query_time=2

[client]
default-character-set=utf8mb4
`;

  return myIniContent;
}

function saveMyIniToFile(outputPath = null) {
  try {
    const content = generateOptimizedMyIni();
    const filePath = outputPath || path.join(process.cwd(), 'my-optimized.ini');
    
    fs.writeFileSync(filePath, content, 'utf-8');
    console.log(`âœ… Optimized MySQL 5.7 configuration saved to: ${filePath}`);
    console.log('');
    console.log('ğŸ“ Ù„ØªØ·Ø¨ÙŠÙ‚ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù:');
    console.log('   1. Ø§Ù†Ø³Ø® Ø§Ù„Ù…Ù„Ù Ø¥Ù„Ù‰ Ù…Ø¬Ù„Ø¯ MySQL 5.7 (Ù…Ø«Ù„Ø§Ù‹: C:\\Program Files\\MySQL\\MySQL Server 5.7\\)');
    console.log('   2. Ø£Ø¹Ø¯ ØªØ³Ù…ÙŠØªÙ‡ Ø¥Ù„Ù‰ "my.ini" (Ø§Ø­ØªÙØ¸ Ø¨Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† Ø§Ù„Ù‚Ø¯ÙŠÙ…)');
    console.log('   3. Ø£Ø¹Ø¯ ØªØ´ØºÙŠÙ„ MySQL:');
    console.log('      net stop MySQL57');
    console.log('      net start MySQL57');
    
    return filePath;
  } catch (error) {
    console.error('Failed to save MySQL configuration file:', error.message);
    return null;
  }
}

function displayOptimizationGuide() {
  console.log('\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
  console.log('â•‘       MySQL Performance Optimization Guide                     â•‘');
  console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
  
  console.log('ğŸ“‹ The application applies the following optimizations automatically:\n');
  console.log('   âœ… Connection Pool: 200 concurrent connections');
  console.log('   âœ… Keep-Alive: Reduced latency for repeated requests');
  console.log('   âœ… MySQL Global Variables: Optimized for VPN/API performance\n');
  
  console.log('ğŸ“ For PERMANENT MySQL optimizations (survives restarts):');
  console.log('   Run: node src/main/mysql-optimizer.js\n');
  
  console.log('ğŸš€ Additional Performance Tips:');
  console.log('   â€¢ Use SSD for MySQL data directory');
  console.log('   â€¢ Allocate at least 8GB RAM to the primary device');
  console.log('   â€¢ Use WireGuard VPN instead of OpenVPN (3-4x faster)');
  console.log('   â€¢ Enable TCP BBR on the server OS for better network performance\n');
}

if (require.main === module) {
  saveMyIniToFile();
  displayOptimizationGuide();
}

module.exports = {
  generateOptimizedMyIni,
  saveMyIniToFile,
  displayOptimizationGuide,
};
