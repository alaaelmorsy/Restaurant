<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø¥Ø¯Ø§Ø±Ø© WhatsApp - POS SA</title>
  <link rel="stylesheet" href="../../styles/output.css">
  <style>
    @font-face { font-family: 'Cairo'; src: url('../../../assets/fonts/Cairo-Regular.ttf') format('truetype'); font-weight: 400; font-display: swap; }
    @font-face { font-family: 'Cairo'; src: url('../../../assets/fonts/Cairo-SemiBold.ttf') format('truetype'); font-weight: 600; font-display: swap; }
    @font-face { font-family: 'Cairo'; src: url('../../../assets/fonts/Cairo-Bold.ttf') format('truetype'); font-weight: 700; font-display: swap; }
    @font-face { font-family: 'Cairo'; src: url('../../../assets/fonts/Cairo-ExtraBold.ttf') format('truetype'); font-weight: 800; font-display: swap; }
    @font-face { font-family: 'Cairo'; src: url('../../../assets/fonts/Cairo-Black.ttf') format('truetype'); font-weight: 900; font-display: swap; }
    
    body {
      font-family: 'Cairo', sans-serif;
      font-weight: 800;
    }

    .qr-container {
      min-height: 320px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
      border: 3px dashed #22c55e;
      border-radius: 16px;
      padding: 24px;
      transition: all 0.3s ease;
    }
    
    .qr-container:hover {
      border-color: #16a34a;
      box-shadow: 0 8px 24px rgba(34, 197, 94, 0.2);
    }
    
    .qr-container img {
      max-width: 300px;
      max-height: 300px;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    }
    
    .status-indicator {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      display: inline-block;
      margin-left: 8px;
      animation: pulse-ring 2s ease-in-out infinite;
    }
    
    .status-connected {
      background: #22c55e;
      box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
    }
    
    .status-disconnected {
      background: #ef4444;
      box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
    }
    
    .status-connecting {
      background: #f59e0b;
      box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7);
    }
    
    @keyframes pulse-ring {
      0% {
        box-shadow: 0 0 0 0 currentColor;
      }
      50% {
        box-shadow: 0 0 0 8px rgba(0, 0, 0, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(0, 0, 0, 0);
      }
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-fade-in {
      animation: fadeInUp 0.6s ease-out forwards;
    }

    @keyframes slideInLeft {
      from {
        opacity: 0;
        transform: translateX(-100%);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes slideOutLeft {
      from {
        opacity: 1;
        transform: translateX(0);
      }
      to {
        opacity: 0;
        transform: translateX(-100%);
      }
    }

    .toast-notification {
      position: fixed;
      top: 100px;
      right: 20px;
      z-index: 9999;
      max-width: 450px;
      animation: slideInLeft 0.4s ease-out forwards;
    }

    .toast-notification.hiding {
      animation: slideOutLeft 0.4s ease-in forwards;
    }

    .card-hover {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .card-hover:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    }

    .btn-primary {
      background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
      transition: all 0.3s ease;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
      transform: translateY(-2px);
      box-shadow: 0 12px 24px rgba(34, 197, 94, 0.3);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      transition: all 0.3s ease;
    }

    .btn-secondary:hover {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      transform: translateY(-2px);
      box-shadow: 0 12px 24px rgba(59, 130, 246, 0.3);
    }

    .btn-danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      transition: all 0.3s ease;
    }

    .btn-danger:hover {
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      transform: translateY(-2px);
      box-shadow: 0 12px 24px rgba(239, 68, 68, 0.3);
    }

    .whatsapp-icon {
      display: inline-block;
      font-size: 2rem;
      filter: drop-shadow(0 4px 8px rgba(34, 197, 94, 0.3));
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      animation: fadeIn 0.2s ease;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 24px;
      padding: 32px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
      animation: slideUp 0.3s ease;
      border: 3px solid #ef4444;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideUp {
      from { 
        opacity: 0;
        transform: translateY(30px) scale(0.95);
      }
      to { 
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-gray-50 via-emerald-50 to-green-50 min-h-screen">
  
  <!-- Toast Notification for Messages Limit -->
  <div id="messagesLimitToast" class="toast-notification hidden">
    <div class="p-4 bg-gradient-to-r from-red-500 to-red-600 border-2 border-red-700 text-white rounded-xl font-black shadow-2xl">
      <div class="flex items-center gap-3">
        <span class="text-3xl">âš ï¸</span>
        <div>
          <div class="text-lg font-black mb-1">Ø§Ù†ØªÙ‡Ù‰ Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…ØªØ§Ø­Ø©!</div>
          <div class="text-sm font-bold opacity-90">ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ Ù„Ù„ØªØ¬Ø¯ÙŠØ¯</div>
        </div>
        <button onclick="hideToast()" class="mr-auto bg-white/20 hover:bg-white/30 rounded-lg p-2 transition-all">
          <span class="text-2xl">âœ•</span>
        </button>
      </div>
    </div>
  </div>
  
  <!-- Logout Confirmation Modal -->
  <div id="logoutModal" class="modal-overlay" onclick="if(event.target === this) closeLogoutModal()">
    <div class="modal-content">
      <div class="text-center mb-6">
        <div class="w-20 h-20 bg-gradient-to-br from-red-500 to-red-600 rounded-full flex items-center justify-center mx-auto mb-4 shadow-xl">
          <span class="text-5xl">âš ï¸</span>
        </div>
        <h2 class="text-2xl font-black text-gray-900 mb-3">ØªØ£ÙƒÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</h2>
        <p class="text-base text-gray-700 font-bold leading-relaxed">
          Ø³ÙŠØªÙ… Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©.
        </p>
        <p class="text-base text-gray-700 font-bold leading-relaxed mt-2">
          Ø³ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø³Ø­ Ø±Ù…Ø² QR Ù„Ù„Ø±Ø¨Ø· Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.
        </p>
      </div>
      
      <div class="flex gap-4">
        <button onclick="confirmLogout()" class="flex-1 px-6 py-4 text-white font-black rounded-xl transition-all shadow-lg hover:shadow-xl transform hover:scale-105 text-lg" style="background: #dc2626;">
          ğŸšª Ù†Ø¹Ù…ØŒ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        </button>
        <button onclick="closeLogoutModal()" class="flex-1 px-6 py-4 text-gray-800 font-black rounded-xl transition-all shadow-lg hover:shadow-xl transform hover:scale-105 text-lg" style="background: #e5e7eb; border: 2px solid #9ca3af;">
          âŒ Ø¥Ù„ØºØ§Ø¡
        </button>
      </div>
    </div>
  </div>
  
  <!-- Header -->
  <header class="bg-white shadow-lg sticky top-0 z-50 border-b-4 border-emerald-500">
    <div class="container mx-auto px-6 py-4">
      <div class="flex items-center justify-between">
        <!-- Brand -->
        <div class="flex items-center gap-4">
          <div class="w-14 h-14 bg-gradient-to-br from-emerald-500 to-green-600 rounded-2xl flex items-center justify-center shadow-xl">
            <span class="text-4xl">ğŸ“±</span>
          </div>
          <div>
            <h1 class="text-2xl font-black text-gray-800">Ø¥Ø¯Ø§Ø±Ø© WhatsApp</h1>
            <p class="text-sm text-gray-500 font-bold">Ø±Ø¨Ø· Ø­Ø³Ø§Ø¨ WhatsApp Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙÙˆØ§ØªÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</p>
          </div>
        </div>

        <!-- Back Button -->
        <button onclick="window.location.href='../main/index.html'" class="px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white font-black rounded-xl hover:from-blue-600 hover:to-blue-700 transition-all shadow-lg hover:shadow-xl transform hover:scale-105">
          â¬… Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        </button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container mx-auto px-6 py-8">
    
    <!-- Alert Messages -->
    <div id="errorDiv" class="hidden mb-6 p-5 bg-red-50 border-2 border-red-500 text-red-700 rounded-2xl font-black shadow-lg animate-fade-in">
      <div class="flex items-center gap-3">
        <span class="text-3xl">âŒ</span>
        <span id="errorText"></span>
      </div>
    </div>
    
    <div id="successDiv" class="hidden mb-6 p-5 bg-emerald-50 border-2 border-emerald-500 text-emerald-700 rounded-2xl font-black shadow-lg animate-fade-in">
      <div class="flex items-center gap-3">
        <span class="text-3xl">âœ…</span>
        <span id="successText"></span>
      </div>
    </div>

    <!-- Messages Counter Banner - Professional -->
    <div id="messagesCounterBanner" class="mb-6">
      <div class="grid grid-cols-3 gap-4">
        <!-- Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰) -->
        <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-lg p-4 text-white">
          <div class="flex items-center justify-between mb-2">
            <span class="text-2xl">ğŸ“Š</span>
            <div class="bg-white/20 px-2 py-1 rounded text-xs font-bold">Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div>
          </div>
          <div class="text-center">
            <div id="totalMessages" class="text-4xl font-black mb-1">-</div>
            <div class="text-xs font-bold opacity-90">Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</div>
          </div>
        </div>

        <!-- Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© -->
        <div id="remainingCard" class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl shadow-lg p-4 text-white">
          <div class="flex items-center justify-between mb-2">
            <span class="text-2xl">ğŸ’¬</span>
            <div class="bg-white/20 px-2 py-1 rounded text-xs font-bold">Ù…ØªØ¨Ù‚ÙŠ</div>
          </div>
          <div class="text-center">
            <div id="remainingMessages" class="text-4xl font-black mb-1">-</div>
            <div class="text-xs font-bold opacity-90">Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</div>
          </div>
        </div>

        <!-- Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© -->
        <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-xl shadow-lg p-4 text-white">
          <div class="flex items-center justify-between mb-2">
            <span class="text-2xl">âœ…</span>
            <div class="bg-white/20 px-2 py-1 rounded text-xs font-bold">Ù…ÙØ±Ø³Ù„</div>
          </div>
          <div class="text-center">
            <div id="sentMessages" class="text-4xl font-black mb-1">-</div>
            <div class="text-xs font-bold opacity-90">Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©</div>
          </div>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
      
      <!-- Connection Status & QR Card -->
      <div class="card-hover bg-white rounded-2xl shadow-2xl p-8 border-2 border-emerald-100 animate-fade-in">
        <div class="flex items-center justify-between mb-6 pb-4 border-b-2 border-gray-100">
          <h2 class="text-2xl font-black text-gray-800 flex items-center gap-2">
            <span class="text-3xl">ğŸ”—</span>
            Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
          </h2>
          <div class="flex items-center gap-3 bg-gray-50 px-4 py-2 rounded-xl">
            <span id="statusText" class="text-base font-black text-gray-700">ØºÙŠØ± Ù…ØªØµÙ„</span>
            <span id="statusIndicator" class="status-indicator status-disconnected"></span>
          </div>
        </div>

        <div id="qrSection" class="mb-6">
          <div class="qr-container" id="qrContainer">
            <div class="text-center">
              <div class="whatsapp-icon mb-4">ğŸ“±</div>
              <p class="text-gray-600 font-black mb-6 text-lg">Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ "Ø±Ø¨Ø· WhatsApp" Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„</p>
              <button onclick="initializeWhatsApp()" class="btn-primary px-8 py-4 text-white rounded-xl font-black shadow-xl text-lg">
                ğŸš€ Ø±Ø¨Ø· WhatsApp Ø§Ù„Ø¢Ù†
              </button>
            </div>
          </div>
        </div>

        <div class="flex gap-4">
          <button onclick="checkStatus()" class="flex-1 btn-secondary px-5 py-4 text-white rounded-xl font-black shadow-lg">
            ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
          </button>
          <button onclick="logout()" class="flex-1 btn-danger px-5 py-4 text-white rounded-xl font-black shadow-lg">
            ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬
          </button>
        </div>
      </div>

      <!-- Test Sending Card -->
      <div class="card-hover bg-white rounded-2xl shadow-2xl p-8 border-2 border-blue-100 animate-fade-in" style="animation-delay: 0.1s;">
        <h2 class="text-2xl font-black text-gray-800 mb-6 pb-4 border-b-2 border-gray-100 flex items-center gap-2">
          <span class="text-3xl">ğŸ“¤</span>
          Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
        </h2>
        
        <div class="mb-5">
          <label class="block text-base font-black text-gray-700 mb-3">ğŸ“ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
          <input 
            type="text" 
            id="testPhone" 
            placeholder="05xxxxxxxx Ø£Ùˆ 9665xxxxxxxx" 
            class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl font-black focus:outline-none focus:ring-4 focus:ring-blue-300 focus:border-blue-500 transition-all text-lg"
          >
          <p class="text-sm text-gray-500 mt-2 font-bold">ğŸ’¡ Ù…Ø«Ø§Ù„: 0501234567 Ø£Ùˆ 966501234567</p>
        </div>

        <div class="mb-6">
          <label class="block text-base font-black text-gray-700 mb-3">ğŸ’¬ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</label>
          <textarea 
            id="testMessage" 
            rows="4" 
            placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©..."
            class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl font-black focus:outline-none focus:ring-4 focus:ring-blue-300 focus:border-blue-500 transition-all text-base resize-none"
          ></textarea>
        </div>

        <button onclick="sendTestMessage()" class="btn-primary w-full px-6 py-4 text-white rounded-xl font-black shadow-xl text-lg mb-6">
          ğŸš€ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©
        </button>

        <div class="p-5 bg-gradient-to-br from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-xl">
          <div class="flex items-start gap-3">
            <span class="text-2xl">ğŸ’¡</span>
            <div>
              <h3 class="text-base font-black text-blue-900 mb-2">Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ù‡Ù…Ø©</h3>
              <p class="text-sm text-blue-700 font-bold leading-relaxed">
                Ø¨Ø¹Ø¯ Ø±Ø¨Ø· WhatsApp Ø¨Ù†Ø¬Ø§Ø­ØŒ Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙÙˆØ§ØªÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙƒÙ…Ù„ÙØ§Øª PDF Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>


  </main>

  <script>
    let qrCheckInterval = null;
    let toastTimeout = null;
    let toastShownOnLoad = false;

    function showToast() {
      const toast = document.getElementById('messagesLimitToast');
      toast.classList.remove('hidden', 'hiding');
      
      if (toastTimeout) {
        clearTimeout(toastTimeout);
      }
      
      toastTimeout = setTimeout(() => {
        hideToast();
      }, 8000);
    }

    function hideToast() {
      const toast = document.getElementById('messagesLimitToast');
      toast.classList.add('hiding');
      
      setTimeout(() => {
        toast.classList.add('hidden');
        toast.classList.remove('hiding');
      }, 400);
      
      if (toastTimeout) {
        clearTimeout(toastTimeout);
        toastTimeout = null;
      }
    }

    function setError(msg) {
      const errorDiv = document.getElementById('errorDiv');
      const errorText = document.getElementById('errorText');
      const successDiv = document.getElementById('successDiv');
      
      if (msg) {
        errorText.textContent = msg;
        errorDiv.classList.remove('hidden');
        successDiv.classList.add('hidden');
      } else {
        errorDiv.classList.add('hidden');
      }
    }

    function setSuccess(msg) {
      const errorDiv = document.getElementById('errorDiv');
      const successDiv = document.getElementById('successDiv');
      const successText = document.getElementById('successText');
      
      if (msg) {
        successText.textContent = msg;
        successDiv.classList.remove('hidden');
        errorDiv.classList.add('hidden');
      } else {
        successDiv.classList.add('hidden');
      }
    }

    function updateStatus(connected, state = '') {
      const statusText = document.getElementById('statusText');
      const statusIndicator = document.getElementById('statusIndicator');
      
      if (connected) {
        statusText.textContent = 'Ù…ØªØµÙ„ âœ…';
        statusText.className = 'text-base font-black text-emerald-600';
        statusIndicator.className = 'status-indicator status-connected';
        setSuccess('ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø¹Ø¨Ø± WhatsApp');
      } else {
        if (state === 'connecting') {
          statusText.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...';
          statusText.className = 'text-base font-black text-amber-600';
          statusIndicator.className = 'status-indicator status-connecting';
        } else {
          statusText.textContent = 'ØºÙŠØ± Ù…ØªØµÙ„';
          statusText.className = 'text-base font-black text-red-600';
          statusIndicator.className = 'status-indicator status-disconnected';
        }
      }
    }

    async function initializeWhatsApp() {
      try {
        console.log('initializeWhatsApp started');
        setError('');
        setSuccess('');
        updateStatus(false, 'connecting');
        
        const qrContainer = document.getElementById('qrContainer');
        qrContainer.innerHTML = `
          <div class="text-center">
            <div class="animate-spin text-6xl mb-4">â³</div>
            <p class="text-gray-600 font-black text-lg">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø© ÙˆØ§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®Ø§Ø¯Ù… WhatsApp...</p>
          </div>
        `;

        console.log('Starting QR polling immediately...');
        startQRPolling();

        console.log('Calling whatsapp_initialize...');
        setSuccess('ØªÙ… Ø¨Ø¯Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ØŒ Ø§Ù†ØªØ¸Ø± Ø¸Ù‡ÙˆØ± Ø±Ù…Ø² QR...');
        
        window.api.whatsapp_initialize().then(result => {
          console.log('Initialize completed:', result);
          if (!result.success) {
            setError('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©: ' + (result.error || 'ÙØ´Ù„ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©'));
          }
        }).catch(error => {
          console.error('Initialize error:', error);
          setError('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©: ' + (error.message || error));
        });

      } catch (error) {
        console.error('initializeWhatsApp error:', error);
        const errorMsg = (error.message || error).toString();
        
        if (errorMsg.includes('browser is already running')) {
          setError('Ø§Ù„Ù…ØªØµÙØ­ Ù…ÙØªÙˆØ­ Ù…Ù† Ù…Ø­Ø§ÙˆÙ„Ø© Ø³Ø§Ø¨Ù‚Ø©. ÙŠØ¬Ø¨ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.');
          const qrContainer = document.getElementById('qrContainer');
          qrContainer.innerHTML = `
            <div class="text-center">
              <div class="text-6xl mb-4">âš ï¸</div>
              <p class="text-red-600 font-black mb-4 text-lg">Ø§Ù„Ù…ØªØµÙØ­ Ù…ÙØªÙˆØ­ Ø¨Ø§Ù„ÙØ¹Ù„</p>
              <p class="text-gray-600 font-bold text-sm mb-6">ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø«Ù… Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</p>
              <button onclick="window.location.reload()" class="btn-secondary px-8 py-4 text-white rounded-xl font-black shadow-lg">
                ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
              </button>
            </div>
          `;
        } else {
          setError('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©: ' + errorMsg);
          const qrContainer = document.getElementById('qrContainer');
          qrContainer.innerHTML = `
            <div class="text-center">
              <div class="text-6xl mb-4">âŒ</div>
              <p class="text-red-600 font-black mb-6 text-lg">ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„</p>
              <button onclick="initializeWhatsApp()" class="btn-primary px-8 py-4 text-white rounded-xl font-black shadow-lg">
                ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
              </button>
            </div>
          `;
        }
        updateStatus(false);
      }
    }

    function startQRPolling() {
      console.log('startQRPolling function called');
      if (qrCheckInterval) {
        console.log('Clearing existing interval');
        clearInterval(qrCheckInterval);
      }
      
      console.log('Setting up new interval...');
      qrCheckInterval = setInterval(async () => {
        console.log('Polling interval triggered');
        try {
          console.log('Calling whatsapp_get_qr...');
          const qrResult = await window.api.whatsapp_get_qr();
          console.log('QR Result:', qrResult);
          
          if (qrResult.success && qrResult.qr) {
            console.log('QR Code found, updating UI');
            const qrContainer = document.getElementById('qrContainer');
            qrContainer.innerHTML = `
              <div class="text-center">
                <p class="text-emerald-600 font-black mb-4 text-xl">ğŸ“± Ø§Ù…Ø³Ø­ Ù‡Ø°Ø§ Ø§Ù„Ø±Ù…Ø² Ù…Ù† ØªØ·Ø¨ÙŠÙ‚ WhatsApp</p>
                <img src="${qrResult.qr}" alt="QR Code" class="mx-auto">
                <p class="text-gray-500 font-bold mt-4 text-sm">â± ÙŠÙ†ØªÙ‡ÙŠ Ø®Ù„Ø§Ù„ Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ†</p>
              </div>
            `;
          } else {
            console.log('No QR Code yet');
          }

          const statusResult = await window.api.whatsapp_status();
          console.log('Status result:', statusResult);
          if (statusResult.success && statusResult.connected) {
            console.log('Connected! Stopping polling');
            clearInterval(qrCheckInterval);
            updateStatus(true);
            const qrContainer = document.getElementById('qrContainer');
            qrContainer.innerHTML = `
              <div class="text-center">
                <div class="text-8xl mb-6">âœ…</div>
                <p class="text-emerald-600 font-black text-3xl mb-3">ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­!</p>
                <p class="text-gray-600 font-bold text-lg">WhatsApp Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¢Ù†</p>
              </div>
            `;
          }
        } catch (error) {
          console.error('QR polling error:', error);
        }
      }, 2000);
      console.log('Interval set up complete');
    }

    async function checkStatus() {
      try {
        setError('');
        const result = await window.api.whatsapp_status();
        
        if (result.success) {
          updateStatus(result.connected, result.state);
          if (!result.connected) {
            setError('ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ù€ WhatsApp - ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø±Ø¨Ø· Ø£ÙˆÙ„Ø§Ù‹');
          }
        } else {
          setError('ÙØ´Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø§Ù„Ø©: ' + (result.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
          updateStatus(false);
        }
      } catch (error) {
        console.error(error);
        setError('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø§Ù„Ø©: ' + (error.message || error));
        updateStatus(false);
      }
    }

    function showLogoutModal() {
      const modal = document.getElementById('logoutModal');
      if (modal) {
        modal.classList.add('show');
      }
    }

    function closeLogoutModal() {
      const modal = document.getElementById('logoutModal');
      if (modal) {
        modal.classList.remove('show');
      }
    }

    function logout() {
      showLogoutModal();
    }

    async function confirmLogout() {
      closeLogoutModal();
      
      try {
        setError('');
        setSuccess('â³ Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ÙˆØ­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø©...');
        
        await window.api.whatsapp_disconnect();
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        const result = await window.api.whatsapp_logout();
        
        if (result.success) {
          setSuccess('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­. Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©...');
          updateStatus(false);
          if (qrCheckInterval) clearInterval(qrCheckInterval);
          
          setTimeout(() => {
            window.location.reload();
          }, 1500);
        } else {
          setError('âŒ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬: ' + (result.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
        }
      } catch (error) {
        console.error(error);
        setError('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬: ' + (error.message || error));
      }
    }

    async function sendTestMessage() {
      try {
        setError('');
        setSuccess('');

        const phone = document.getElementById('testPhone').value.trim();
        const message = document.getElementById('testMessage').value.trim();

        if (!phone) {
          setError('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø£ÙˆÙ„Ø§Ù‹');
          return;
        }

        if (!message) {
          setError('âš ï¸ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹');
          return;
        }

        setSuccess('â³ Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©...');

        const result = await window.api.whatsapp_send_text(phone, message);
        
        if (result.success) {
          setSuccess('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!');
          document.getElementById('testMessage').value = '';
          await loadMessagesStats();
        } else {
          if (result.limitReached) {
            showToast();
            await loadMessagesStats();
          } else {
            setError('âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ' + (result.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
          }
        }
      } catch (error) {
        console.error(error);
        setError('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ' + (error.message || error));
      }
    }

    // Close modal on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeLogoutModal();
      }
    });

    async function loadMessagesStats(isInitialLoad = false) {
      try {
        console.log('Loading messages stats...');
        const result = await window.api.whatsapp_get_messages_stats();
        console.log('Messages stats result:', result);
        
        if (result && result.success) {
          const { limit, sent, remaining } = result;
          console.log(`Stats - Limit: ${limit}, Sent: ${sent}, Remaining: ${remaining}`);
          
          document.getElementById('remainingMessages').textContent = remaining !== undefined ? remaining : '-';
          document.getElementById('totalMessages').textContent = limit !== undefined ? limit : '-';
          document.getElementById('sentMessages').textContent = sent !== undefined ? sent : '-';
          
          const remainingCard = document.getElementById('remainingCard');
          if (remaining !== undefined) {
            if (remaining <= 10 && remaining > 0) {
              remainingCard.className = 'bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl shadow-lg p-4 text-white';
            } else if (remaining <= 0) {
              remainingCard.className = 'bg-gradient-to-br from-red-500 to-red-600 rounded-xl shadow-lg p-4 text-white';
              if (isInitialLoad && !toastShownOnLoad) {
                showToast();
                toastShownOnLoad = true;
              }
            } else {
              remainingCard.className = 'bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl shadow-lg p-4 text-white';
            }
          }
        } else {
          console.error('Failed to load stats:', result ? result.error : 'No result returned');
          document.getElementById('remainingMessages').textContent = '0';
          document.getElementById('totalMessages').textContent = '0';
          document.getElementById('sentMessages').textContent = '0';
        }
      } catch (error) {
        console.error('Error loading messages stats:', error);
        document.getElementById('remainingMessages').textContent = 'Ø®Ø·Ø£';
        document.getElementById('totalMessages').textContent = 'Ø®Ø·Ø£';
        document.getElementById('sentMessages').textContent = 'Ø®Ø·Ø£';
      }
    }

    // Check status on page load
    console.log('Page loaded, initializing...');
    console.log('window.api available:', !!window.api);
    console.log('whatsapp_get_messages_stats available:', !!window.api?.whatsapp_get_messages_stats);
    
    checkStatus();
    
    // Load messages stats with retry
    setTimeout(() => {
      console.log('Calling loadMessagesStats...');
      loadMessagesStats(true);
    }, 500);
    
    // Refresh messages stats every 30 seconds
    setInterval(loadMessagesStats, 30000);
  </script>
</body>
</html>
