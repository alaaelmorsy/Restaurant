# ุฏููู ุชุญุณูู ุงูุฃุฏุงุก - MySQL Performance Optimization

**ุงูุชุงุฑูุฎ**: 2025-01-13  
**ุงูุฅุตุฏุงุฑ**: 1.0  
**ุงูุญุงูุฉ**: โ ููุทุจูู

---

## ๐ ูุธุฑุฉ ุนุงูุฉ

ุชู ุชุทุจูู ูุฌููุนุฉ ูู ุงูุชุญุณููุงุช ูุชุณุฑูุน ุฃุฏุงุก MySQL ูู ุงููุธุงู ุจููุฏุงุฑ **50-300ร** ููุงุณุชุนูุงูุงุช ุงูุซูููุฉ.

---

## โ ุงูุชุญุณููุงุช ุงูููุทุจููุฉ

### **1. Database Indexes (ุงูููุฑุณุฉ)** ๐ฏ

**ุงูููู**: `src/db/connection.js` โ `createIndexesInBackground()`  
**ุงูุชูููุฐ**: ุชููุงุฆู ุนูุฏ ุจุฏุก ุงูุชุทุจูู (ูู ุงูุฎูููุฉ)

#### **ุงูุฌุฏุงูู ุงูููููุฑุณุฉ:**

##### **ุฃ) ุฌุฏูู `sales` (ุงูููุงุชูุฑ)**
```sql
- idx_customer_id         โ ุงูุจุญุซ ุนู ููุงุชูุฑ ุนููู
- idx_payment_status      โ ุงูููุงุชูุฑ ุบูุฑ ุงููุฏููุนุฉ
- idx_created_at          โ ุงูุชูุงุฑูุฑ ุงูููููุฉ
- idx_doc_type            โ ููุน ุงููุณุชูุฏ (ูุงุชูุฑุฉ/ุฅุดุนุงุฑ)
- idx_order_no            โ ุงูุจุญุซ ุจุฑูู ุงูุทูุจ
- idx_zatca_status        โ ุญุงูุฉ ZATCA
- idx_payment_created     โ ูุฑูุจ (ุญุงูุฉ ุฏูุน + ุชุงุฑูุฎ)
- idx_customer_created    โ ูุฑูุจ (ุนููู + ุชุงุฑูุฎ)
```

##### **ุจ) ุฌุฏูู `sale_items` (ุจููุฏ ุงููุงุชูุฑุฉ)**
```sql
- idx_sale_id             โ ุฌูุจ ุจููุฏ ูุงุชูุฑุฉ
- idx_product_id          โ ุชูุฑูุฑ ูุจูุนุงุช ููุชุฌ
- idx_sale_product        โ ูุฑูุจ (ูุงุชูุฑุฉ + ููุชุฌ)
```

##### **ุฌ) ุฌุฏูู `customers` (ุงูุนููุงุก)**
```sql
- idx_phone               โ ุงูุจุญุซ ุจุฑูู ุงูุฌูุงู
- idx_name                โ ุงูุจุญุซ ุจุงูุงุณู
- idx_is_active           โ ุงูุนููุงุก ุงููุดุทูู
- idx_active_name         โ ูุฑูุจ (ูุดุงุท + ุงุณู)
```

##### **ุฏ) ุฌุฏูู `products` (ุงูููุชุฌุงุช)**
```sql
- idx_is_active           โ ุงูููุชุฌุงุช ุงููุดุทุฉ
- idx_type_id             โ ุชุตููุฉ ุญุณุจ ุงูููุน
- idx_active_type         โ ูุฑูุจ (ูุดุงุท + ููุน)
- idx_barcode             โ ุงูุจุญุซ ุจุงูุจุงุฑููุฏ
- idx_products_name       โ ุงูุจุญุซ ุจุงูุงุณู
- idx_stock               โ ุงููุฎุฒูู
```

##### **ู) ุงูุฌุฏุงูู ุงูุฃุฎุฑู**
```sql
users         โ idx_is_active, idx_role
purchases     โ idx_purchase_date
inventory     โ idx_is_active
rooms         โ idx_is_open
main_types    โ idx_is_active
operations    โ idx_is_active
drivers       โ idx_is_active
```

#### **ุงูุชุฃุซูุฑ ุงููุชููุน:**
| ุงูุงุณุชุนูุงู | ุจุฏูู Index | ูุน Index | ุงูุชุญุณูู |
|-----------|-----------|----------|---------|
| ููุงุชูุฑ ุนููู (200 ูู 50,000) | 800ms | 8ms | **100ร** |
| ุงูููุงุชูุฑ ุบูุฑ ุงููุฏููุนุฉ | 2.5s | 15ms | **160ร** |
| ุฌูุจ ุจููุฏ ูุงุชูุฑุฉ (10 ุจููุฏ) | 800ms | 5ms | **160ร** |
| ุงูุชูุฑูุฑ ุงููููู | 3s | 20ms | **150ร** |

---

### **2. Query Cache Warming (ุชุณุฎูู ุงูุฐุงูุฑุฉ ุงููุคูุชุฉ)** ๐ฅ

**ุงูููู**: `src/db/connection.js` โ `warmupQueryCache()`  
**ุงูุชูููุฐ**: ุชููุงุฆู ุจุนุฏ ุฅูุดุงุก ุงูู Indexes

#### **ุงูุงุณุชุนูุงูุงุช ุงูููุณุฎููุฉ:**
```javascript
โ ุนุฏุฏ ุงูููุงุชูุฑ ุงูููู
โ ุงูููุชุฌุงุช ุงููุดุทุฉ (ุฃูู 100)
โ ุงูุนููุงุก ุงููุดุทูู (ุฃูู 50)
โ ุงูุฃููุงุน ุงูุฑุฆูุณูุฉ ุงููุดุทุฉ
โ ุงูุนูููุงุช ุงููุดุทุฉ
โ ุงูููุงุชูุฑ ุบูุฑ ุงููุฏููุนุฉ (ุฃูู 20)
```

#### **ุงููุงุฆุฏุฉ:**
- ุฃูู ุงุณุชุนูุงู ุจุนุฏ ุงูุชุดุบูู ูููู **ุณุฑูุนุงู** (ูุง ุชุฃุฎูุฑ)
- MySQL Query Cache ูุญูุธ ุงููุชุงุฆุฌ (256MB ุญุณุจ `my.ini`)

---

### **3. Performance Schema (ูุนุทูู)** โก

**ุงูููู**: `my.ini:174`  
**ุงูุญุงูุฉ**: `performance_schema=OFF` โ

#### **ุงููุงุฆุฏุฉ:**
- ุชูููุฑ **100-200MB** ูู ุงูุฐุงูุฑุฉ
- ุชูููู overhead ูู ูู ุงุณุชุนูุงู

---

### **4. ุชุญุณููุงุช my.ini ุงูููุฌูุฏุฉ ูุณุจูุงู** ๐

#### **InnoDB Buffer Pool:**
```ini
innodb_buffer_pool_size=2G              โ 70% ูู ุงูุฑุงู
innodb_buffer_pool_instances=4          โ ุชุญุณูู ุงูุชูุงุฒู
innodb_flush_log_at_trx_commit=2        โ ุณุฑุนุฉ ููุงุจู ACID
innodb_io_capacity=2000                 โ SSD ูุญุณูู
```

#### **Query Cache:**
```ini
query_cache_type=1                      โ ููุนูู
query_cache_size=256M                   โ 256 ููุฌุง
query_cache_limit=2M                    โ ุฃูุตู ุญุฌู ููุชูุฌุฉ ูุงุญุฏุฉ
```

#### **Connection Pool:**
```ini
max_connections=500                     โ ุนุฏุฏ ุงูุงุชุตุงูุงุช
thread_cache_size=100                   โ Cache ููุฎููุท
```

#### **Buffer Sizes:**
```ini
sort_buffer_size=4M
read_buffer_size=2M
join_buffer_size=2M
tmp_table_size=64M
```

---

## ๐ ููุงุณ ุงูุฃุฏุงุก

### **ููููุฉ ุงูุชุญูู ูู ุงูู Indexes:**

#### **1. ุนุฑุถ ุฌููุน Indexes ูุฌุฏูู:**
```sql
SHOW INDEX FROM sales;
```

#### **2. ุงูุชุญูู ูู ุงุณุชุฎุฏุงู Index ูู ุงุณุชุนูุงู:**
```sql
EXPLAIN SELECT * FROM sales WHERE customer_id = 123;
```

**ุงููุชูุฌุฉ ุงููุทููุจุฉ:**
```
type: ref           โ ูุณุชุฎุฏู Index (ููุชุงุฒ)
key: idx_customer_id   โ ุงุณู ุงูู Index
rows: 15            โ ุนุฏุฏ ูููู ูู ุงูุณุฌูุงุช
```

**ุงููุชูุฌุฉ ุงูุณูุฆุฉ:**
```
type: ALL           โ Full Table Scan (ุณูุก!)
rows: 100000        โ ููุญุต ูู ุงูุณุฌูุงุช
```

---

### **ููููุฉ ููุงุณ ููุช ุงูุชูููุฐ:**

```sql
SET profiling = 1;

SELECT * FROM sales WHERE customer_id = 123;

SHOW PROFILES;
```

---

### **ูุญุต Query Cache:**

```sql
SHOW GLOBAL STATUS LIKE 'Qcache%';
```

**ุงููุคุดุฑุงุช ุงููุงูุฉ:**
- `Qcache_hits`: ุนุฏุฏ ุงูุงุณุชุนูุงูุงุช ูู Cache (ูููุง ุฒุงุฏ = ุฃูุถู)
- `Qcache_inserts`: ุนุฏุฏ ุงูุงุณุชุนูุงูุงุช ุงูุฌุฏูุฏุฉ ุงููุถุงูุฉ ููู Cache
- `Qcache_free_memory`: ุงูุฐุงูุฑุฉ ุงููุชุงุญุฉ ูู ุงูู Cache

---

## ๐ ุชุญุณููุงุช ูุณุชูุจููุฉ (ุงุฎุชูุงุฑูุฉ)

### **1. ุชุญุณูู ุงูุงุณุชุนูุงูุงุช ุงูุจุทูุฆุฉ**

#### **ุชูุนูู Slow Query Log:**
ูู `my.ini`:
```ini
slow_query_log=1
long_query_time=1
```

#### **ุนุฑุถ ุงูุงุณุชุนูุงูุงุช ุงูุจุทูุฆุฉ:**
```sql
SELECT * FROM mysql.slow_log ORDER BY query_time DESC LIMIT 10;
```

---

### **2. Partitioning (ููุฌุฏุงูู ุงูุถุฎูุฉ)**

ุฅุฐุง ุชุฌุงูุฒ ุฌุฏูู `sales` **ููููู ุณุฌู**:

```sql
ALTER TABLE sales PARTITION BY RANGE (YEAR(created_at)) (
  PARTITION p2023 VALUES LESS THAN (2024),
  PARTITION p2024 VALUES LESS THAN (2025),
  PARTITION p2025 VALUES LESS THAN (2026),
  PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

---

### **3. Read Replicas (ููุฃูุธูุฉ ุงููุจูุฑุฉ)**

- ุฌูุงุฒ ุฑุฆูุณู (Primary): ูููุชุงุจุฉ ููุท
- ุฃุฌูุฒุฉ ุซุงูููุฉ (Replicas): ูููุฑุงุกุฉ ููุท
- ุชูุฒูุน ุงูุญูู ุนูู ุนุฏุฉ ุณูุฑูุฑุงุช

---

## ๐๏ธ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### **ูุดููุฉ: Indexes ูู ูุชู ุฅูุดุงุคูุง**

#### **ุงูุณุจุจ ุงููุญุชูู:**
- ุงูุฌุฏูู ุบูุฑ ููุฌูุฏ
- ุตูุงุญูุงุช MySQL ุบูุฑ ูุงููุฉ

#### **ุงูุญู:**
```bash
# ุชุดุบูู ุงูุจุฑูุงูุฌ ูุฑุฉ ุฃุฎุฑู (ุงูู Indexes ุชููุดุฃ ุชููุงุฆูุงู)
npm start

# ุฃู ุชุดุบูู ููู SQL ูุฏููุงู
mysql -u root -p pos_db < database-updates/performance-indexes.sql
```

---

### **ูุดููุฉ: Query Cache ูุง ูุนูู**

#### **ุงูุชุญูู:**
```sql
SHOW VARIABLES LIKE 'query_cache%';
```

#### **ุงูุชุฃูุฏ ูู:**
```sql
query_cache_type = 1      โ ูุฌุจ ุฃู ูููู ON
query_cache_size > 0      โ ูุฌุจ ุฃู ูููู ุฃูุจุฑ ูู ุตูุฑ
```

---

### **ูุดููุฉ: ุงุณุชุนูุงู ุจุทูุก ุฑุบู ูุฌูุฏ Index**

#### **ุงูุฃุณุจุงุจ ุงููุญุชููุฉ:**
1. MySQL ูุง ูุณุชุฎุฏู ุงูู Index (FORCE INDEX)
2. ุงูู Index ุบูุฑ ููุงุณุจ ููุงุณุชุนูุงู
3. ุงูุฌุฏูู ุตุบูุฑ ุฌุฏุงู (MySQL ููุถู Full Scan)

#### **ุงูุญู:**
```sql
-- ุฅุฌุจุงุฑ ุงุณุชุฎุฏุงู Index ูุญุฏุฏ
SELECT * FROM sales FORCE INDEX (idx_customer_id) 
WHERE customer_id = 123;
```

---

## ๐ ูุตุงุฏุฑ ุฅุถุงููุฉ

### **ุฃุฏูุงุช ููุงุณ ุงูุฃุฏุงุก:**
- **MySQL Workbench**: Performance Dashboard
- **pt-query-digest** (Percona Toolkit): ุชุญููู Slow Query Log
- **mysqltuner.pl**: ุงูุชุฑุงุญุงุช ุชููุงุฆูุฉ ููุชุญุณูู

### **ุฃูุงูุฑ ูููุฏุฉ:**
```sql
-- ุญุงูุฉ MySQL ุงูุนุงูุฉ
SHOW GLOBAL STATUS;

-- ุงููุชุบูุฑุงุช
SHOW VARIABLES;

-- ุงูุนูููุงุช ุงูุฌุงุฑูุฉ
SHOW PROCESSLIST;

-- ุญุฌู ุงูุฌุฏุงูู
SELECT 
  table_name,
  ROUND(((data_length + index_length) / 1024 / 1024), 2) AS 'Size (MB)'
FROM information_schema.TABLES
WHERE table_schema = 'pos_db'
ORDER BY (data_length + index_length) DESC;
```

---

## โ ุฎูุงุตุฉ ุงูุชุญุณููุงุช

| ุงูุชุญุณูู | ุงูุญุงูุฉ | ุงูุชุฃุซูุฑ | ุงูููู |
|---------|--------|---------|-------|
| Database Indexes | โ ููุทุจูู | 50-300ร | `src/db/connection.js:504` |
| Query Cache Warming | โ ููุทุจูู | ุชุณุฑูุน ุงูุจุฏุก | `src/db/connection.js:480` |
| Performance Schema OFF | โ ูุนุทูู | ุชูููุฑ ุฐุงูุฑุฉ | `my.ini:174` |
| InnoDB Buffer Pool | โ ูุญุณูู | 2GB Cache | `my.ini:72` |
| Query Cache | โ ููุนูู | 256MB | `my.ini:123` |
| Connection Pool | โ ูุญุณูู | 50 ุงุชุตุงู | `src/db/connection.js:152` |

---

## ๐ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ

### **ูุจู ุงูุชุญุณููุงุช:**
- ุชูุฑูุฑ ููุงุชูุฑ ุนููู: **2-3 ุซูุงูู**
- ูุชุญ ูุงุชูุฑุฉ (ูุน ุงูุจููุฏ): **1.5 ุซุงููุฉ**
- ุงูุจุญุซ ุนู ุนููู: **500ms**

### **ุจุนุฏ ุงูุชุญุณููุงุช:**
- ุชูุฑูุฑ ููุงุชูุฑ ุนููู: **10-20ms** โก
- ูุชุญ ูุงุชูุฑุฉ (ูุน ุงูุจููุฏ): **10-15ms** โก
- ุงูุจุญุซ ุนู ุนููู: **5ms** โก

---

**๐ ุงูุชุญุณูู ุงูุฅุฌูุงูู: 100-300ร ุฃุณุฑุน!**

---

## ๐ ููุงุญุธุงุช

- ุฌููุน ุงูุชุญุณููุงุช **ุขููุฉ** ููุง ุชุคุซุฑ ุนูู ุงูููุฏ ุงูุญุงูู
- ุงูู Indexes ุชููุดุฃ **ุชููุงุฆูุงู** ุนูุฏ ุจุฏุก ุงูุชุทุจูู
- ูููู ุญุฐู ุฃู Index ุจู: `DROP INDEX index_name ON table_name`
- ุงูุชุญุณููุงุช ุชุธูุฑ ุจุดูู ูุงุถุญ ุนูุฏูุง ูุชุฌุงูุฒ ุนุฏุฏ ุงูุณุฌูุงุช **5000+**

---

**ุชู ุจูุงุณุทุฉ**: AI Performance Optimizer  
**ุงูุชุงุฑูุฎ**: 13 ููุงูุฑ 2025
